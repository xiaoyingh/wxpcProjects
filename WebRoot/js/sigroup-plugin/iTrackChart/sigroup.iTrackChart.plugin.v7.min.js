var iTrackChart={showTitleFlag:!1,showImpTitleOnlyFlag:!1,titleLen:10,contentLen:50,scale:.6,zoomtype:1,rate:1.2,playBtnId:"itc-play",stopBtnId:"itc-stop",sliderId:"itc-slider",tipId:"itc-tip",toolBar:'<div class="ui-widget-header ui-corner-all" style="font-size:10px;position:absolute;bottom:0;"><table style="width:100%;font-size:10px;" ><tr><td width="65"><button id="itc-play">\u64ad\u653e</button><button id="itc-stop">\u505c\u6b62</button></td><td><div id="itc-slider" style="margin-left:10px;margin-right:10px;"></div></td><td width="70"><span id="itc-tip"></span></td></tr></table></div>',legend:'<div class="mtrack-legend"><table><tr><td><div class="mtrack-bd"><div class="mtrack-color"></div></div></td><td><span class="mtrack-text">\u4e8b\u4ef6</span></td></tr><tr><td><div class="mtrack-bd"><div class="mtrack-color"></div></div></td><td><span class="mtrack-text">\u666e\u901a\u70b9</span></td></tr><tr><td><div class="mtrack-bd"><div class="mtrack-color"></div></div></td><td><span class="mtrack-text">\u5f15\u7206\u70b9</span></td></tr><tr><td><div class="mtrack-bd"><div class="mtrack-color"></div></div></td><td><span class="mtrack-text">\u63a8\u624b</span></td></tr><tr><td><div class="mtrack-bd"><div class="mtrack-color"></div></div></td><td><span class="mtrack-text">\u5f15\u7206+\u63a8\u624b</span></td></tr></table></div>',color:["#f6ff00","#00bfff","#ff0093","#1cff00","#ff8000"]};iTrackChart.TrackEvolutionChart=function(a,b){this.container=$("#"+a),this.jsonObj=b&&b.jsonObj?b.jsonObj:null,this.jsonFile=b&&b.jsonFile?b.jsonFile:null,this.padding=b&&b.padding?b.padding:0,this.width=b&&b.width?b.width:this.container.width()-2*this.padding,this.height=b&&b.height?b.height:this.container.height()-2*this.padding,this.callback=b&&b.callback?b.callback:null,this.titleLen=b&&b.titleLen?b.titleLen:iTrackChart.titleLen,this.contentLen=b&&b.contentLen?b.contentLen:iTrackChart.contentLen,this.showTitleFlag=!b||1!=b.showTitleFlag&&0!=b.showTitleFlag?iTrackChart.showTitleFlag:b.showTitleFlag,this.showImpTitleOnlyFlag=!b||1!=b.showImpTitleOnlyFlag&&0!=b.showImpTitleOnlyFlag?iTrackChart.showImpTitleOnlyFlag:b.showImpTitleOnlyFlag,this.scale=b&&b.scale?b.scale:iTrackChart.scale,this.rate=b&&b.rate?b.rate:iTrackChart.rate,this.zoomtype=b&&b.zoomtype?b.zoomtype:iTrackChart.zoomtype,this.playBtnId=b&&b.playBtnId?b.playBtnId:iTrackChart.playBtnId,this.stopBtnId=b&&b.stopBtnId?b.stopBtnId:iTrackChart.stopBtnId,this.sliderId=b&&b.sliderId?b.sliderId:iTrackChart.sliderId,this.tipId=b&&b.tipId?b.tipId:iTrackChart.tipId,this.maxRtt=b&&b.maxRtt?b.maxRtt:null,this.minRtt=b&&b.minRtt?b.minRtt:null,this.maxFans=b&&b.maxFans?b.maxFans:null,this.minFans=b&&b.minFans?b.minFans:null,this.tree=null,this.diagonal=null,this.svg=null,this.nodes=null,this.links=null,this.node=null,this.link=null,this.dragFlag=null,this.dragX=null,this.dragY=null,this.transX=this.width/2/this.scale,this.transY=this.height/2/this.scale,this.step=0,this.maxStep=b&&b.maxStep?b.maxStep:0,this.handle=null,this.isPlay=!1},iTrackChart.TrackChart=function(a,b){this.container=$("#"+a),this.jsonObj=b&&b.jsonObj?b.jsonObj:null,this.jsonFile=b&&b.jsonFile?b.jsonFile:null,this.padding=b&&b.padding?b.padding:0,this.width=b&&b.width?b.width:this.container.width()-2*this.padding,this.height=b&&b.height?b.height:this.container.height()-2*this.padding,this.callback=b&&b.callback?b.callback:null,this.titleLen=b&&b.titleLen?b.titleLen:iTrackChart.titleLen,this.contentLen=b&&b.contentLen?b.contentLen:iTrackChart.contentLen,this.showTitleFlag=!b||1!=b.showTitleFlag&&0!=b.showTitleFlag?iTrackChart.showTitleFlag:b.showTitleFlag,this.showImpTitleOnlyFlag=!b||1!=b.showImpTitleOnlyFlag&&0!=b.showImpTitleOnlyFlag?iTrackChart.showImpTitleOnlyFlag:b.showImpTitleOnlyFlag,this.scale=b&&b.scale?b.scale:iTrackChart.scale,this.rate=b&&b.rate?b.rate:iTrackChart.rate,this.zoomtype=b&&b.zoomtype?b.zoomtype:iTrackChart.zoomtype,this.maxRtt=b&&b.maxRtt?b.maxRtt:null,this.minRtt=b&&b.minRtt?b.minRtt:null,this.maxFans=b&&b.maxFans?b.maxFans:null,this.minFans=b&&b.minFans?b.minFans:null,this.tree=null,this.diagonal=null,this.svg=null,this.nodes=null,this.links=null,this.node=null,this.link=null,this.dragFlag=null,this.dragX=null,this.dragY=null,this.transX=this.width/2/this.scale,this.transY=this.height/2/this.scale},iTrackChart.TrackEvolutionChart.prototype.init=function(){var a=this;return a.container.empty(),$(iTrackChart.toolBar).width(a.container.width()).insertAfter(a.container),a.container.tooltip({show:{effect:"slideDown",delay:250}}),a.container.append(iTrackChart.legend),a.container.find(".mtrack-color").each(function(a,b){$(b).css("border-color",iTrackChart.color[a])}),1==a.zoomtype?a.container.get(0).onmousewheel=function(b){var c=0;return b.wheelDelta?c=b.wheelDelta:b.detail&&(c=b.detail),c>0?(a.scale=a.scale*a.rate,a.transX=a.transX>0?a.transX/a.rate:a.transX*a.rate,a.transY=a.transY>0?a.transY/a.rate:a.transY*a.rate):0>c&&(a.scale=a.scale/a.rate,a.transX=a.transX>0?a.transX*a.rate:a.transX/a.rate,a.transY=a.transY>0?a.transY*a.rate:a.transY/a.rate),$(a.svg[0][0]).attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")"),!1}:(a.container.append("<div ref='1' class='zoombtn mblogtrack-zoomin'>+</div><div ref='-1' class='zoombtn mblogtrack-zoomout'>-</div>"),a.container.delegate(".zoombtn","click",function(){var b=parseInt($(this).attr("ref"));b>0?(a.scale=a.scale*a.rate,a.transX=a.transX>0?a.transX/a.rate:a.transX*a.rate,a.transY=a.transY>0?a.transY/a.rate:a.transY*a.rate):0>b&&(a.scale=a.scale/a.rate,a.transX=a.transX>0?a.transX*a.rate:a.transX/a.rate,a.transY=a.transY>0?a.transY*a.rate:a.transY/a.rate),$(a.svg[0][0]).attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")")})),a.container.mousedown(function(b){a.dragFlag=!0,a.dragX=b.clientX,a.dragY=b.clientY,$(document).addClass("unselectable")}),a.container.mouseup(function(){a.dragFlag=!1,$(document).removeClass("unselectable")}),a.container.mousemove(function(b){a.dragFlag&&(a.transX=a.transX-(a.dragX-b.clientX),a.transY=a.transY-(a.dragY-b.clientY),$(a.svg[0][0]).attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")"),a.dragX=b.clientX,a.dragY=b.clientY)}),$("#"+a.playBtnId).button({text:!1,icons:{primary:"ui-icon-play"}}).click(function(){a.isPlay?a.pause():a.setIsPlay(!0).play()}),$("#"+a.stopBtnId).button({text:!1,icons:{primary:"ui-icon-stop"}}).click(function(){a.stop()}),a.genChart(),a},iTrackChart.TrackEvolutionChart.prototype.genChart=function(){var a=this;return a.tree=d3.layout.tree().size([360,a.width]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth}),a.diagonal=d3.svg.diagonal.radial().projection(function(a){return[a.y,a.x/180*Math.PI]}),a.svg=d3.select("#"+a.container.get(0).id).append("svg").attr("width",a.width).attr("height",a.height).append("g").attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")"),a.jsonFile?d3.json(a.jsonFile,function(b,c){console.log(c),a.jsonObj=c,a.renderChart()}):a.jsonObj&&a.renderChart(),a},iTrackChart.TrackEvolutionChart.prototype.renderChart=function(){var a=this;return $("#"+a.tipId).html(a.jsonObj.time[0]),$("#"+a.sliderId).slider({min:0,max:a.jsonObj.time.length-1,range:"min",value:0,slide:function(b,c){$("#"+a.tipId).html(a.jsonObj.time[c.value]),a.pause().setStep(c.value).updateChart()}}),console.log(a.jsonObj.data),a.nodes=a.tree.nodes(a.jsonObj.data),a.links=a.tree.links(a.nodes),a.nodes[0].ishead=!0,a.link=a.svg.selectAll(".link").data(a.links).enter().append("path").attr("class","link").attr("d",a.diagonal),a.node=a.svg.selectAll(".node").data(a.nodes).enter().append("g").attr("class","node tagtext").attr("title",function(a){return a.content?a.content:a.name}).attr("data-id",function(a){return a.id}).attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+a.y+")"}),a.node.append("circle").attr("r",3),a.node.append("text").attr("dy",".31em").attr("text-anchor",function(a){return a.x<180?"start":"end"}).attr("transform",function(a){return a.x<180?"translate(8)":"rotate(180)translate(-8)"}),a.container.delegate("g.node","mouseenter",function(){$(this).css("cursor","pointer")}),a.container.delegate("g.node","mouseleave",function(){$(this).css("cursor","default")}),a.updateChart(),a},iTrackChart.TrackEvolutionChart.prototype.updateChart=function(){var a=this;return a.link.attr("style",function(b){return(b.source.ishead||a.compareRtt(b.source.rtt)&&a.compareFans(b.source.fans)&&a.isShow(b.source.show))&&(b.target.ishead||a.compareRtt(b.target.rtt)&&a.compareFans(b.target.fans)&&a.isShow(b.target.show))?"":"display:none;"}),a.node.attr("style",function(b){var d="";if(b.ishead||a.compareRtt(b.rtt)&&a.compareFans(b.fans)&&a.isShow(b.show))if(b.ishead)d+="fill:"+iTrackChart.color[0]+";";else switch(b.type.charAt(a.step)){case"0":d+="fill:"+iTrackChart.color[1]+";";break;case"1":d+="fill:"+iTrackChart.color[2]+";";break;case"2":d+="fill:"+iTrackChart.color[3]+";";break;case"3":d+="fill:"+iTrackChart.color[4]+";"}else d+="display:none;";return d}),a.node.selectAll("circle").attr("r",function(a){var c=3;if(a.ishead)c<<=3;else switch(a.type){case"0":break;case"1":c<<=1;break;case"2":c<<=1;break;case"3":c<<=1}return c}),a.node.selectAll("text").text(function(b){if(a.showTitleFlag){if(!a.showImpTitleOnlyFlag)return b.name;if(a.isKey(b.type))return b.name}return""}),a.callback&&a.callback(a),a},iTrackChart.TrackEvolutionChart.prototype.setShowTitleFlag=function(a){return this.showTitleFlag=1==a||0==a?a:!0,this},iTrackChart.TrackEvolutionChart.prototype.setShowImpTitleOnlyFlag=function(a){return this.showImpTitleOnlyFlag=1==a||0==a?a:!1,this},iTrackChart.TrackEvolutionChart.prototype.setMaxRtt=function(a){return this.maxRtt=null==a?null:parseInt(a),this},iTrackChart.TrackEvolutionChart.prototype.setMinRtt=function(a){return this.minRtt=null==a?null:parseInt(a),this},iTrackChart.TrackEvolutionChart.prototype.setMaxFans=function(a){return this.maxFans=null==a?null:parseInt(a),this},iTrackChart.TrackEvolutionChart.prototype.setMinFans=function(a){return this.minFans=null==a?null:parseInt(a),this},iTrackChart.TrackEvolutionChart.prototype.setStep=function(a){return this.step=null==a?0:parseInt(a),this},iTrackChart.TrackEvolutionChart.prototype.setIsPlay=function(a){return this.isPlay=1==a||0==a?a:!1,this},iTrackChart.TrackEvolutionChart.prototype.isShow=function(a){var b=this;return a?"1"==a.charAt(b.step)?!0:!1:!0},iTrackChart.TrackEvolutionChart.prototype.isKey=function(a){var b=this;if(a){var c=a.charAt(b.step);return"1"==c||"2"==c||"3"==c?!0:!1}return!1},iTrackChart.TrackEvolutionChart.prototype.compareRtt=function(a){var b=this,c=!0,d=parseInt(a);return c=void 0!=a?null==b.maxRtt&&null==b.minRtt?!0:null==b.maxRtt&&b.minRtt<=d?!0:null==b.minRtt&&b.maxRtt>=d?!0:null!=b.maxRtt&&null!=b.minRtt&&b.minRtt<=d&&b.maxRtt>=d?!0:!1:!0},iTrackChart.TrackEvolutionChart.prototype.compareFans=function(a){var b=this,c=!0,d=parseInt(a);return c=void 0!=a?null==b.maxFans&&null==b.minFans?!0:null==b.maxFans&&b.minFans<=d?!0:null==b.minFans&&b.maxFans>=d?!0:null!=b.maxFans&&null!=b.minFans&&b.minFans<=d&&b.maxFans>=d?!0:!1:!0},iTrackChart.TrackEvolutionChart.prototype.play=function(){var a=this;return a.isPlay&&(a.step<=a.maxStep?($("#"+a.playBtnId).button("option",{label:"pause",icons:{primary:"ui-icon-pause"}}),$("#"+a.sliderId).slider("value",a.step),$("#"+a.tipId).html(a.jsonObj.time[a.step]),a.updateChart(),a.step++,a.handle=setTimeout(function(){a.play()},1e3)):a.stop()),a},iTrackChart.TrackEvolutionChart.prototype.pause=function(){var a=this;return a.isPlay=!1,$("#"+a.playBtnId).button("option",{label:"play",icons:{primary:"ui-icon-play"}}),a},iTrackChart.TrackEvolutionChart.prototype.stop=function(){var a=this;return a.isPlay=!1,a.step=0,a.updateChart(),$("#"+a.sliderId).slider("value",0),$("#"+a.playBtnId).button("option",{label:"play",icons:{primary:"ui-icon-play"}}),a},iTrackChart.TrackChart.prototype.init=function(){var a=this;return a.container.empty(),a.container.tooltip({show:{effect:"slideDown",delay:250}}),a.container.append(iTrackChart.legend),a.container.find(".mtrack-color").each(function(a,b){$(b).css("border-color",iTrackChart.color[a])}),1==a.zoomtype?a.container.get(0).onmousewheel=function(b){var c=0;return b.wheelDelta?c=b.wheelDelta:b.detail&&(c=b.detail),c>0?(a.scale=a.scale*a.rate,a.transX=a.transX>0?a.transX/a.rate:a.transX*a.rate,a.transY=a.transY>0?a.transY/a.rate:a.transY*a.rate):0>c&&(a.scale=a.scale/a.rate,a.transX=a.transX>0?a.transX*a.rate:a.transX/a.rate,a.transY=a.transY>0?a.transY*a.rate:a.transY/a.rate),$(a.svg[0][0]).attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")"),!1}:(a.container.append("<div ref='1' class='zoombtn mblogtrack-zoomin'>+</div><div ref='-1' class='zoombtn mblogtrack-zoomout'>-</div>"),a.container.delegate(".zoombtn","click",function(){var b=parseInt($(this).attr("ref"));b>0?(a.scale=a.scale*a.rate,a.transX=a.transX>0?a.transX/a.rate:a.transX*a.rate,a.transY=a.transY>0?a.transY/a.rate:a.transY*a.rate):0>b&&(a.scale=a.scale/a.rate,a.transX=a.transX>0?a.transX*a.rate:a.transX/a.rate,a.transY=a.transY>0?a.transY*a.rate:a.transY/a.rate),$(a.svg[0][0]).attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")")})),a.container.mousedown(function(b){a.dragFlag=!0,a.dragX=b.clientX,a.dragY=b.clientY,$(document).addClass("unselectable")}),a.container.mouseup(function(){a.dragFlag=!1,$(document).removeClass("unselectable")}),a.container.mousemove(function(b){a.dragFlag&&(a.transX=a.transX-(a.dragX-b.clientX),a.transY=a.transY-(a.dragY-b.clientY),$(a.svg[0][0]).attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")"),a.dragX=b.clientX,a.dragY=b.clientY)}),a.genChart(),a},iTrackChart.TrackChart.prototype.genChart=function(){var a=this;return a.tree=d3.layout.tree().size([360,a.width]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth}),a.diagonal=d3.svg.diagonal.radial().projection(function(a){return[a.y,a.x/180*Math.PI]}),a.svg=d3.select("#"+a.container.get(0).id).append("svg").attr("width",a.width).attr("height",a.height).append("g").attr("transform","scale("+a.scale+") translate("+a.transX+","+a.transY+")"),console.log(a.jsonObj),a.jsonFile?d3.json(a.jsonFile,function(b,c){console.log(c),a.jsonObj=c,a.renderChart()}):a.jsonObj&&a.renderChart(),a},iTrackChart.TrackChart.prototype.renderChart=function(){var a=this;a.nodes=a.tree.nodes(a.jsonObj),a.links=a.tree.links(a.nodes),a.nodes[0].ishead=!0,a.link=a.svg.selectAll(".link").data(a.links).enter().append("path").attr("class","link").attr("d",a.diagonal),a.node=a.svg.selectAll(".node").data(a.nodes).enter().append("g").attr("class","node tagtext").attr("title",function(a){return a.content?a.content:a.name}).attr("data-id",function(a){return a.id}).attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+a.y+")"}),a.node.append("circle").attr("r",3),a.node.append("text").attr("dy",".31em").attr("text-anchor",function(a){return a.x<180?"start":"end"}).attr("transform",function(a){return a.x<180?"translate(8)":"rotate(180)translate(-8)"}),a.container.delegate("g.node","mouseenter",function(){$(this).css("cursor","pointer")}),a.container.delegate("g.node","mouseleave",function(){$(this).css("cursor","default")}),a.updateChart()},iTrackChart.TrackChart.prototype.updateChart=function(){var a=this;return a.link.attr("style",function(b){return(b.source.ishead||a.compareRtt(b.source.rtt)&&a.compareFans(b.source.fans))&&(b.target.ishead||a.compareRtt(b.target.rtt)&&a.compareFans(b.target.fans))?"":"display:none;"}),a.node.attr("style",function(b){var d="";if(b.ishead||a.compareRtt(b.rtt)&&a.compareFans(b.fans))if(b.ishead)d+="fill:"+iTrackChart.color[0]+";";else switch(b.type){case"0":d+="fill:"+iTrackChart.color[1]+";";break;case"1":d+="fill:"+iTrackChart.color[2]+";";break;case"2":d+="fill:"+iTrackChart.color[3]+";";break;case"3":d+="fill:"+iTrackChart.color[4]+";"}else d+="display:none;";return d}),a.node.selectAll("circle").attr("r",function(a){var c=3;if(a.ishead)c<<=3;else switch(a.type){case"0":break;case"1":c<<=1;break;case"2":c<<=1;break;case"3":c<<=1}return c}),a.node.selectAll("text").text(function(b){if(a.showTitleFlag){if(!a.showImpTitleOnlyFlag)return b.name;if(a.isKey(b.type))return b.name}return""}),a.callback&&a.callback(a),a},iTrackChart.TrackChart.prototype.setShowTitleFlag=function(a){return this.showTitleFlag=1==a||0==a?a:!0,this},iTrackChart.TrackChart.prototype.setShowImpTitleOnlyFlag=function(a){return this.showImpTitleOnlyFlag=1==a||0==a?a:!1,this},iTrackChart.TrackChart.prototype.setMaxRtt=function(a){return this.maxRtt=null==a?null:parseInt(a),this},iTrackChart.TrackChart.prototype.setMinRtt=function(a){return this.minRtt=null==a?null:parseInt(a),this},iTrackChart.TrackChart.prototype.setMaxFans=function(a){return this.maxFans=null==a?null:parseInt(a),this},iTrackChart.TrackChart.prototype.setMinFans=function(a){return this.minFans=null==a?null:parseInt(a),this},iTrackChart.TrackChart.prototype.compareRtt=function(a){var b=this,c=!0,d=parseInt(a);return c=void 0!=a?null==b.maxRtt&&null==b.minRtt?!0:null==b.maxRtt&&b.minRtt<=d?!0:null==b.minRtt&&b.maxRtt>=d?!0:null!=b.maxRtt&&null!=b.minRtt&&b.minRtt<=d&&b.maxRtt>=d?!0:!1:!0},iTrackChart.TrackChart.prototype.compareFans=function(a){var b=this,c=!0,d=parseInt(a);return c=void 0!=a?null==b.maxFans&&null==b.minFans?!0:null==b.maxFans&&b.minFans<=d?!0:null==b.minFans&&b.maxFans>=d?!0:null!=b.maxFans&&null!=b.minFans&&b.minFans<=d&&b.maxFans>=d?!0:!1:!0},iTrackChart.TrackChart.prototype.isKey=function(a){return a?"1"==a||"2"==a||"3"==a?!0:!1:!1};